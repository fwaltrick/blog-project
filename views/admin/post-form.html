{% extends "admin/_admin-layout.html" %}

{% block title %}
  {% if isEdit %}Edit Post{% else %}Create New Post{% endif %}
  - Admin Panel
{% endblock %}

{% block header %}
  <div class="flex items-center justify-between">
    <h1 class="text-2xl font-sans font-semibold text-dark">
      {% if isEdit %}Edit Post{% else %}Create New Post{% endif %}
    </h1>
    <a
      href="/admin/posts"
      class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-secondary bg-white hover:bg-gray-50 transition-colors"
    >
      <svg
        class="h-4 w-4 mr-2"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M15 19l-7-7 7-7"
        ></path>
      </svg>
      Back to Posts
    </a>
  </div>
{% endblock %}

{% block content %}
  <div class="max-w-4xl mx-auto">
    <div class="bg-white shadow rounded-lg">
      <form
        id="postForm"
        class="p-6 space-y-6"
        data-is-edit="{% if isEdit %}true{% else %}false{% endif %}"
        data-post-id="{% if isEdit %}{{ id }}{% else %}{% endif %}"
      >
        <!-- Title -->
        <div>
          <label for="title" class="block text-sm font-medium text-dark"
            >Title</label
          >
          <input
            type="text"
            id="title"
            name="title"
            value="{{ post.title }}"
            required
            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
          />
        </div>

        <!-- Author -->
        <div>
          <label for="author" class="block text-sm font-medium text-gray-700"
            >Author</label
          >
          <input
            type="text"
            id="author"
            name="author"
            value="{{ post.author if post else '' }}"
            required
            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
          />
        </div>

        <!-- Teaser -->
        <div>
          <label for="teaser" class="block text-sm font-medium text-gray-700"
            >Teaser</label
          >
          <textarea
            id="teaser"
            name="teaser"
            rows="3"
            required
            placeholder="Brief description of the post..."
            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
          >
{{ post.teaser if post else '' }}</textarea
          >
        </div>

        <!-- Content -->
        <div>
          <label for="content" class="block text-sm font-medium text-gray-700"
            >Content</label
          >
          <textarea
            id="content"
            name="content"
            rows="12"
            required
            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
          >
{{ post.content if post else '' }}</textarea
          >
        </div>

        <!-- Image URL -->
        <div>
          <label for="image" class="block text-sm font-medium text-gray-700"
            >Image URL</label
          >
          <input
            type="url"
            id="image"
            name="image"
            value="{{ post.image if post else '' }}"
            placeholder="https://example.com/image.jpg"
            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
          />
        </div>

        <!-- Created At (only for editing) -->
        {% if isEdit %}
          <input type="hidden" name="createdAt" value="{{ post.createdAt }}" />
        {% else %}
          <input
            type="hidden"
            name="createdAt"
            value="{{ Date.now() / 1000 | round }}"
          />
        {% endif %}

        <!-- Submit Button -->
        <div class="flex items-center justify-end space-x-4">
          <a
            href="/admin/posts"
            class="px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-secondary bg-white hover:bg-gray-50 transition-colors"
          >
            Cancel
          </a>
          <button
            type="submit"
            class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary hover:bg-opacity-90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition-colors"
          >
            {% if isEdit %}
              <svg
                class="h-4 w-4 mr-2"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
                ></path>
              </svg>
              Update Post
            {% else %}
              <svg
                class="h-4 w-4 mr-2"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 6v6m0 0v6m0-6h6m-6 0H6"
                ></path>
              </svg>
              Create Post
            {% endif %}
          </button>
        </div>
      </form>
    </div>
  </div>

  <script>
    document
      .getElementById("postForm")
      .addEventListener("submit", function (e) {
        e.preventDefault();

        const form = e.target;
        const formData = new FormData(form);
        const data = Object.fromEntries(formData);

        // Get data from HTML attributes
        const isEdit = form.getAttribute("data-is-edit") === "true";
        const postId = form.getAttribute("data-post-id");

        if (isEdit) {
          // Update existing post with PATCH
          fetch(`/admin/posts/${postId}`, {
            method: "PATCH",
            headers: {
              "Content-Type": "application/json",
              Accept: "application/json",
            },
            body: JSON.stringify(data),
          })
            .then((response) => {
              if (response.ok) {
                window.location.href = "/admin/posts";
              } else {
                alert("Error updating post. Please try again.");
              }
            })
            .catch((error) => {
              console.error("Error:", error);
              alert("Error updating post. Please try again.");
            });
        } else {
          // Create new post with POST
          fetch("/admin/posts", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Accept: "application/json",
            },
            body: JSON.stringify(data),
          })
            .then((response) => {
              if (response.ok) {
                window.location.href = "/admin/posts";
              } else {
                alert("Error creating post. Please try again.");
              }
            })
            .catch((error) => {
              console.error("Error:", error);
              alert("Error creating post. Please try again.");
            });
        }
      });
  </script>
{% endblock %}
